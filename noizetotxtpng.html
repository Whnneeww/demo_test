<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像にノイズを追加</title>
</head>
<body>
    <h1>画像にノイズを追加して文字列を埋め込み</h1>
    <input type="file" id="imageInput" accept="image/*">
    <input type="text" id="textInput" placeholder="埋め込みたい文字列（5〜10%のサイズ）">
    <button id="processButton">処理する</button>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const imageInput = document.getElementById('imageInput');
        const textInput = document.getElementById('textInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = URL.createObjectURL(file);
        });

        class ZenChannel {
            static encode(data, text) {
                const maxLength = Math.floor(data.length * 0.1);
                const encodedText = text.substring(0, maxLength);
                
                for (let j = 0; j < encodedText.length; j++) {
                    const charCode = encodedText.charCodeAt(j);
                    const index = j * 4; // 1文字あたり4要素（RGBA）
                    if (index < data.length) {
                        data[index] = charCode;     // R
                        data[index + 1] = 0;        // G
                        data[index + 2] = 0;        // B
                        data[index + 3] = 255;      // A
                    }
                }
                return data;
            }
        }

        document.getElementById('processButton').addEventListener('click', () => {
            const text = textInput.value;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // ノイズを非常に小さく追加
            const noiseIntensity = 5; // ノイズの強度（低いほど目立たない）
            for (let i = 0; i < data.length; i += 4) {
                data[i] += (Math.random() - 0.5) * noiseIntensity; // R
                data[i + 1] += (Math.random() - 0.5) * noiseIntensity; // G
                data[i + 2] += (Math.random() - 0.5) * noiseIntensity; // B
            }

            // ゼンチャンネルを利用して文字列をエンコード
            ZenChannel.encode(data, text);

            ctx.putImageData(imageData, 0, 0);
            console.log("ノイズと文字列の追加が完了しました！");
        });
    </script>
</body>
</html>
